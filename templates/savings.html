{% extends "base.html" %} {% block title %}Savings Management{% endblock %} {%
block content %}

<header class="mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="display-4 mb-2">
        <i class="bi bi-piggy-bank-fill text-primary"></i> Savings Management
      </h1>
      <p class="lead text-muted mb-0">
        Track your monthly income, savings, and related expenses.
      </p>
    </div>
  </div>
</header>

<!-- Summary Cards Row -->
<div class="row g-3 mb-4">
  <div class="col-lg-4">
    <div
      class="card border-0 shadow-sm"
      style="
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        );
        border-left: 4px solid #667eea;
      "
    >
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <div
            class="p-2 rounded-circle d-inline-block"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            "
          >
            <i class="bi bi-wallet2 fs-4 text-white"></i>
          </div>
        </div>
        <h6 class="text-muted mb-2 fw-semibold">Gross Savings</h6>
        <p class="h3 mb-1 fw-bold" style="color: #667eea">
          {{ "%.2f"|format(total_savings) }}
        </p>
        <p class="text-muted small mb-0">AUD</p>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div
      class="card border-0 shadow-sm"
      style="
        background: linear-gradient(
          135deg,
          rgba(248, 80, 50, 0.1) 0%,
          rgba(231, 56, 39, 0.1) 100%
        );
        border-left: 4px solid #f85032;
      "
    >
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <div
            class="p-2 rounded-circle d-inline-block"
            style="
              background: linear-gradient(135deg, #f85032 0%, #e73827 100%);
            "
          >
            <i class="bi bi-arrow-down-circle fs-4 text-white"></i>
          </div>
        </div>
        <h6 class="text-muted mb-2 fw-semibold">Total Deductions</h6>
        <p class="h3 mb-1 fw-bold text-danger">
          {{ "%.2f"|format(total_expenses_from_savings) }}
        </p>
        <p class="text-muted small mb-0">AUD</p>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div
      class="card border-0 shadow-sm"
      style="
        background: linear-gradient(
          135deg,
          rgba(11, 163, 96, 0.1) 0%,
          rgba(60, 186, 146, 0.1) 100%
        );
        border-left: 4px solid #0ba360;
      "
    >
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <div
            class="p-2 rounded-circle d-inline-block"
            style="
              background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%);
            "
          >
            <i class="bi bi-trophy fs-4 text-white"></i>
          </div>
        </div>
        <h6 class="text-muted mb-2 fw-semibold">Net Savings</h6>
        <p class="h3 mb-1 fw-bold text-success">
          {{ "%.2f"|format(net_savings) }}
        </p>
        <p class="text-muted small mb-0">AUD</p>
      </div>
    </div>
  </div>
</div>

<!-- Main Content Layout -->
<div class="row g-4">
  <!-- Left Column - Tables (Wider) -->
  <div class="col-lg-8">
    <!-- Monthly Cash Flow Section -->
    <div class="card shadow-lg mb-4 border-0">
      <div
        class="card-header text-white py-3"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
      >
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="bi bi-calendar-check"></i> Monthly Cash Flow
            <span class="badge bg-white text-primary ms-2"
              >{{ monthly_cash_flow|length }} entries</span
            >
          </h4>
          <form
            action="{{ url_for('update_sort_order') }}"
            method="post"
            class="d-inline"
          >
            <div class="btn-group btn-group-sm" role="group">
              <input type="radio" class="btn-check" name="sort_order"
              id="savings_cf_newest_first" value="newest_first" {% if
              settings.get('table_sort_order', 'newest_first') == 'newest_first'
              %}checked{% endif %} onchange="this.form.submit()">
              <label
                class="btn btn-outline-light"
                for="savings_cf_newest_first"
              >
                <i class="bi bi-arrow-down-circle"></i> Newest First
              </label>

              <input type="radio" class="btn-check" name="sort_order"
              id="savings_cf_oldest_first" value="oldest_first" {% if
              settings.get('table_sort_order') == 'oldest_first' %}checked{%
              endif %} onchange="this.form.submit()">
              <label
                class="btn btn-outline-light"
                for="savings_cf_oldest_first"
              >
                <i class="bi bi-arrow-up-circle"></i> Oldest First
              </label>
            </div>
          </form>
        </div>
      </div>
      <div class="card-body p-0">
        <div
          class="table-responsive"
          style="max-height: 400px; overflow-y: auto"
        >
          <table class="table table-hover mb-0">
            <thead
              class="sticky-top"
              style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
              "
            >
              <tr>
                <th class="py-3 px-4"><i class="bi bi-calendar3"></i> Month</th>
                <th class="py-3 px-4 text-end">
                  <i class="bi bi-cash-coin"></i> Income
                </th>
                <th class="py-3 px-4 text-end">
                  <i class="bi bi-bank"></i> Loan Repayment
                </th>
                <th class="py-3 px-4 text-end">
                  <i class="bi bi-calculator"></i> Net
                </th>
                <th class="py-3 px-4 text-center">
                  <i class="bi bi-gear"></i> Actions
                </th>
              </tr>
            </thead>
            <tbody>
              {% set sorted_entries = monthly_cash_flow|reverse if
              settings.get('table_sort_order', 'newest_first') == 'newest_first'
              else monthly_cash_flow %} {% for entry in sorted_entries %}
              <tr>
                <td class="py-3 px-4 fw-semibold">
                  {{ datetime.strptime(entry.month, '%Y-%m').strftime('%B %Y')
                  }}
                </td>
                <td class="py-3 px-4 text-end text-success fw-semibold">
                  {{ "%.2f"|format(entry.income) }} AUD
                </td>
                <td class="py-3 px-4 text-end text-danger">
                  {{ "%.2f"|format(entry.loan_repayment) }} AUD
                </td>
                <td class="py-3 px-4 text-end fw-bold" style="color: #667eea">
                  {{ "%.2f"|format(entry.income - entry.loan_repayment) }} AUD
                </td>
                <td class="py-3 px-4 text-center">
                  <div class="btn-group btn-group-sm">
                    <a
                      href="{{ url_for('edit_monthly_entry_by_month', month=entry.month) }}"
                      class="btn btn-outline-primary"
                      title="Edit"
                    >
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a
                      href="{{ url_for('delete_by_month', month=entry.month) }}"
                      class="btn btn-outline-danger"
                      title="Delete"
                      onclick="return confirm('Delete this entry?');"
                    >
                      <i class="bi bi-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="sticky-bottom" style="background: #f8f9fa">
              <tr class="fw-bold">
                <td class="py-3 px-4">Total</td>
                <td class="py-3 px-4 text-end text-success">
                  {{ "%.2f"|format(monthly_cash_flow|sum(attribute='income')) }}
                  AUD
                </td>
                <td class="py-3 px-4 text-end text-danger">
                  {{
                  "%.2f"|format(monthly_cash_flow|sum(attribute='loan_repayment'))
                  }} AUD
                </td>
                <td class="py-3 px-4 text-end" style="color: #667eea">
                  {{ "%.2f"|format(monthly_cash_flow|sum(attribute='income') -
                  monthly_cash_flow|sum(attribute='loan_repayment')) }} AUD
                </td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        {% if not monthly_cash_flow %}
        <div class="p-5 text-center">
          <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
          <p class="text-muted">
            No entries yet. Add monthly income using the form on the right.
          </p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Expenses From Savings Section -->
    <div class="card shadow-lg border-0">
      <div
        class="card-header text-white py-3"
        style="background: linear-gradient(135deg, #f85032 0%, #e73827 100%)"
      >
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="bi bi-receipt"></i> Expenses From Savings
            <span class="badge bg-white text-danger ms-2"
              >{{ expenses_from_savings|length }} expenses</span
            >
          </h4>
          <form
            action="{{ url_for('update_sort_order') }}"
            method="post"
            class="d-inline"
          >
            <div class="btn-group btn-group-sm" role="group">
              <input type="radio" class="btn-check" name="sort_order"
              id="savings_exp_newest_first" value="newest_first" {% if
              settings.get('table_sort_order', 'newest_first') == 'newest_first'
              %}checked{% endif %} onchange="this.form.submit()">
              <label
                class="btn btn-outline-light"
                for="savings_exp_newest_first"
              >
                <i class="bi bi-arrow-down-circle"></i> Newest First
              </label>

              <input type="radio" class="btn-check" name="sort_order"
              id="savings_exp_oldest_first" value="oldest_first" {% if
              settings.get('table_sort_order') == 'oldest_first' %}checked{%
              endif %} onchange="this.form.submit()">
              <label
                class="btn btn-outline-light"
                for="savings_exp_oldest_first"
              >
                <i class="bi bi-arrow-up-circle"></i> Oldest First
              </label>
            </div>
          </form>
        </div>
      </div>
      <div class="card-body p-0">
        <div
          class="table-responsive"
          style="max-height: 400px; overflow-y: auto"
        >
          <table class="table table-hover mb-0">
            <thead
              class="sticky-top"
              style="
                background: linear-gradient(135deg, #f85032 0%, #e73827 100%);
                color: white;
              "
            >
              <tr>
                <th class="py-3 px-4">
                  <i class="bi bi-tag"></i> Expense Name
                </th>
                <th class="py-3 px-4 text-end">
                  <i class="bi bi-currency-dollar"></i> Amount
                </th>
                <th class="py-3 px-4 text-center">
                  <i class="bi bi-gear"></i> Actions
                </th>
              </tr>
            </thead>
            <tbody>
              {% set sorted_expenses = expenses_from_savings|reverse if
              settings.get('table_sort_order', 'newest_first') == 'newest_first'
              else expenses_from_savings %} {% for expense in sorted_expenses %}
              <tr>
                <td class="py-3 px-4">{{ expense.name }}</td>
                <td class="py-3 px-4 text-end fw-semibold text-danger">
                  {{ "%.2f"|format(expense.amount) }} AUD
                </td>
                <td class="py-3 px-4 text-center">
                  <div class="btn-group btn-group-sm">
                    <a
                      href="{{ url_for('edit_savings_expense', index=loop.index0) }}"
                      class="btn btn-outline-primary"
                      title="Edit"
                    >
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a
                      href="{{ url_for('delete_item', list_name='expenses_from_savings', index=loop.index0) }}"
                      class="btn btn-outline-danger"
                      title="Delete"
                      onclick="return confirm('Delete this expense?');"
                    >
                      <i class="bi bi-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="sticky-bottom" style="background: #f8f9fa">
              <tr class="fw-bold">
                <td class="py-3 px-4">Total Expenses</td>
                <td class="py-3 px-4 text-end text-danger">
                  {{
                  "%.2f"|format(expenses_from_savings|sum(attribute='amount'))
                  }} AUD
                </td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        {% if not expenses_from_savings %}
        <div class="p-5 text-center">
          <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
          <p class="text-muted">
            No expenses yet. Add expenses using the form on the right.
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Column - Forms (Narrower, Sticky) -->
  <div class="col-lg-4">
    <div class="sticky-top" style="top: 100px">
      <!-- Add Monthly Lump Sum Form -->
      <div
        class="card shadow-lg mb-4 border-0"
        style="border-left: 5px solid #667eea"
      >
        <div
          class="card-header text-white py-3"
          style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
        >
          <h5 class="mb-0">
            <i class="bi bi-plus-circle-fill"></i> Add Monthly Lump Sum
          </h5>
        </div>
        <div class="card-body p-4">
          <form
            action="{{ url_for('add_lump_sum_monthly_income') }}"
            method="post"
          >
            <div class="mb-3">
              <label class="form-label fw-semibold">
                <i class="bi bi-calendar3"></i> For Month
              </label>
              <div class="row g-2">
                <div class="col-7">
                  <select class="form-select" name="month" required>
                    <option selected disabled value="">Month...</option>
                    {% for month in months %}
                    <option value="{{ month.value }}">{{ month.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-5">
                  <select class="form-select" name="year" required>
                    <option selected disabled value="">Year...</option>
                    {% for year in years %}
                    <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="gross_income" class="form-label fw-semibold">
                <i class="bi bi-cash-stack"></i> Gross Monthly Income
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text">AUD</span>
                <input
                  type="number"
                  class="form-control"
                  id="gross_income"
                  name="gross_income"
                  step="0.01"
                  placeholder="0.00"
                  required
                />
              </div>
              <div class="form-text">
                <i class="bi bi-info-circle"></i> Tax ({{
                settings.tax_rate_percent }}%) and loan repayment will be
                deducted automatically.
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 py-2 shadow">
              <i class="bi bi-check-circle"></i> Add to Cash Flow
            </button>
          </form>
        </div>
      </div>

      <!-- Add Savings Expense Form -->
      <div
        class="card shadow-lg border-0"
        style="border-left: 5px solid #f85032"
      >
        <div
          class="card-header text-white py-3"
          style="background: linear-gradient(135deg, #f85032 0%, #e73827 100%)"
        >
          <h5 class="mb-0">
            <i class="bi bi-dash-circle-fill"></i> Add Savings Expense
          </h5>
        </div>
        <div class="card-body p-4">
          <form action="{{ url_for('add_saving_expense') }}" method="post">
            <div class="mb-3">
              <label for="name" class="form-label fw-semibold">
                <i class="bi bi-tag"></i> Expense Name
              </label>
              <input
                type="text"
                class="form-control form-control-lg"
                id="name"
                name="name"
                placeholder="e.g., Accommodation, Tuition"
                required
              />
            </div>
            <div class="mb-3">
              <label for="amount" class="form-label fw-semibold">
                <i class="bi bi-currency-dollar"></i> Amount
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text">AUD</span>
                <input
                  type="number"
                  class="form-control"
                  id="amount"
                  name="amount"
                  step="0.01"
                  placeholder="0.00"
                  required
                />
              </div>
            </div>
            <button type="submit" class="btn btn-danger w-100 py-2 shadow">
              <i class="bi bi-check-circle"></i> Add Expense
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .table thead.sticky-top th {
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .table tfoot.sticky-bottom td {
    position: sticky;
    bottom: 0;
    z-index: 10;
  }

  .table-responsive::-webkit-scrollbar {
    width: 8px;
  }

  .table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  .table-responsive::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 4px;
  }

  .table tbody tr {
    transition: all 0.2s ease;
  }

  .table tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.08);
    transform: scale(1.01);
  }

  /* Mobile Optimizations for Savings Page */
  @media (max-width: 768px) {
    /* Header section - better mobile layout */
    header .d-flex {
      flex-direction: column;
      gap: 0.75rem;
    }

    /* Summary cards - stack nicely */
    .col-lg-4 {
      padding: 0.25rem !important;
    }

    /* Main layout - tables and forms full width */
    .col-lg-8,
    .col-lg-4 {
      width: 100%;
      max-width: 100%;
    }

    /* Tables - more compact */
    .table-responsive {
      max-height: 350px !important;
    }

    /* Card headers with sort buttons */
    .card-header .d-flex {
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-start !important;
    }

    .card-header h4 {
      font-size: 1rem !important;
      width: 100%;
    }

    .card-header .btn-group {
      width: 100%;
      display: flex;
    }

    .card-header .btn-group label {
      flex: 1;
      font-size: 0.75rem;
      padding: 0.4rem 0.5rem;
    }

    /* Progress bars - adjust */
    .progress {
      height: 22px;
    }

    .progress-bar {
      font-size: 0.8rem;
    }

    /* Remove sticky positioning on forms for mobile */
    .sticky-top {
      position: relative !important;
      top: 0 !important;
    }
  }

  @media (max-width: 576px) {
    /* Summary cards - more compact */
    .card-body .p-2 {
      padding: 0.5rem !important;
    }

    .card-body .bi {
      font-size: 1.25rem !important;
    }

    .card-body h6 {
      font-size: 0.85rem !important;
    }

    .card-body .h3 {
      font-size: 1.25rem !important;
    }

    /* Tables - ultra compact for phones */
    .table {
      font-size: 0.75rem !important;
    }

    .table thead th,
    .table tbody td,
    .table tfoot td {
      padding: 0.5rem 0.35rem !important;
      font-size: 0.75rem;
    }

    /* Disable hover effects on mobile */
    .table tbody tr:hover {
      transform: none;
    }

    /* Action buttons - smaller */
    .btn-group-sm .btn {
      padding: 0.25rem 0.35rem;
      font-size: 0.7rem;
    }

    .btn-group-sm .btn i {
      font-size: 0.85rem;
    }

    /* Forms - optimize inputs */
    .form-control-lg,
    .input-group-lg .form-control {
      font-size: 0.9rem !important;
      padding: 0.55rem 0.7rem !important;
    }

    .input-group-lg .input-group-text {
      font-size: 0.9rem !important;
      padding: 0.55rem 0.7rem !important;
    }

    .form-label {
      font-size: 0.85rem !important;
    }

    /* Date pickers - better mobile layout */
    .row.g-2 {
      gap: 0.35rem !important;
    }

    /* Net Savings display - adjust size */
    header .display-4 {
      font-size: 1.5rem !important;
    }

    header .display-5 {
      font-size: 1.25rem !important;
    }

    /* Card spacing */
    .card.mb-4 {
      margin-bottom: 1rem !important;
    }

    /* Badge sizes */
    .badge {
      font-size: 0.7rem;
      padding: 0.3rem 0.5rem;
    }
  }

  /* Very small phones */
  @media (max-width: 375px) {
    /* Even more compact tables */
    .table {
      font-size: 0.7rem !important;
    }

    .table thead th,
    .table tbody td,
    .table tfoot td {
      padding: 0.4rem 0.25rem !important;
    }

    /* Hide some table column icons to save space */
    .table th i,
    .table td i.bi-currency-dollar {
      display: none;
    }

    /* Form sections - minimal padding */
    .card-body {
      padding: 0.65rem !important;
    }

    /* Buttons - smaller */
    .btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.7rem;
    }
  }

  /* Landscape optimization */
  @media (max-width: 768px) and (orientation: landscape) {
    .table-responsive {
      max-height: 250px !important;
    }

    .card {
      margin-bottom: 0.5rem !important;
    }

    /* Summary cards in a row for landscape */
    .row.g-3 {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    .row.g-3 > .col-lg-4 {
      flex: 0 0 auto;
      width: 50%;
    }
  }
</style>

{% endblock %}
