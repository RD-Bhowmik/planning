{% extends "base.html" %} {% block title %}Edit Loan Details{% endblock %} {%
block content %}
<header class="mb-5">
  <h1 class="display-5 mb-2">
    <i class="bi bi-pencil-square text-primary"></i> Edit Loan Details
  </h1>
  <p class="lead text-muted">Update your loan amount and repayment schedule</p>
</header>

<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow-lg border-0">
      <div class="card-body p-5">
        <form action="{{ url_for('update_loan') }}" method="post">
          <fieldset class="mb-5">
            <legend class="h4 fw-bold mb-4">
              <i class="bi bi-cash-coin text-primary"></i> Loan Amount
            </legend>
            <div class="mb-4">
              <label for="loan_amount_bdt" class="form-label fw-semibold">
                <i class="bi bi-currency-exchange"></i> Loan Amount (BDT)
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text bg-light">
                  <i class="bi bi-coin"></i>
                </span>
                <input
                  type="number"
                  step="1"
                  class="form-control form-control-lg"
                  id="loan_amount_bdt"
                  name="loan_amount_bdt"
                  value="{{ loan_data.amount_bdt }}"
                  required
                />
                <span class="input-group-text bg-light fw-semibold">BDT</span>
              </div>
              <div class="form-text mt-2">
                <i class="bi bi-info-circle"></i> Current exchange rate: 1 BDT =
                {{ settings.bdt_to_aud_rate }} AUD
              </div>
            </div>

            <div
              class="alert alert-info border-0 shadow-sm"
              style="
                background: linear-gradient(
                  135deg,
                  rgba(102, 126, 234, 0.1) 0%,
                  rgba(118, 75, 162, 0.1) 100%
                );
              "
            >
              <div class="d-flex align-items-center">
                <i
                  class="bi bi-calculator fs-3 me-3"
                  style="color: #667eea"
                ></i>
                <div>
                  <div class="fw-semibold mb-1">Converted Amount:</div>
                  <span
                    id="converted_amount"
                    class="fs-4 fw-bold"
                    style="color: #667eea"
                  >
                    {{ "%.2f"|format(loan_data.amount_aud) }} AUD
                  </span>
                </div>
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-5">
            <legend class="h4 fw-bold mb-4">
              <i class="bi bi-percent text-warning"></i> Interest Rate
            </legend>
            <div class="mb-3">
              <label for="loan_interest_rate" class="form-label fw-semibold">
                <i class="bi bi-graph-up"></i> Annual Interest Rate (%)
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text bg-light">
                  <i class="bi bi-percent"></i>
                </span>
                <input
                  type="number"
                  step="0.01"
                  class="form-control form-control-lg"
                  id="loan_interest_rate"
                  name="loan_interest_rate"
                  value="{{ settings.get('loan_interest_rate', 0) }}"
                  min="0"
                  required
                />
                <span class="input-group-text bg-light fw-semibold"
                  >% per year</span
                >
              </div>
              <div class="form-text mt-2">
                <i class="bi bi-info-circle"></i> Enter 0 if there's no interest
                on your loan
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-5">
            <legend class="h4 fw-bold mb-4">
              <i class="bi bi-calendar-range text-info"></i> Loan Period
            </legend>
            <div class="mb-3">
              <label for="loan_period_months" class="form-label fw-semibold">
                <i class="bi bi-clock-history"></i> Repayment Period (Months)
              </label>
              <div class="input-group input-group-lg">
                <span class="input-group-text bg-light">
                  <i class="bi bi-calendar3"></i>
                </span>
                <input
                  type="number"
                  step="1"
                  class="form-control form-control-lg"
                  id="loan_period_months"
                  name="loan_period_months"
                  value="{{ settings.get('loan_period_months', 12) }}"
                  min="1"
                  required
                />
                <span class="input-group-text bg-light fw-semibold"
                  >months</span
                >
              </div>
              <div class="form-text mt-2">
                <i class="bi bi-info-circle"></i> How many months do you plan to
                repay the loan?
              </div>
            </div>
          </fieldset>

          <fieldset class="mb-5">
            <legend class="h4 fw-bold mb-4">
              <i class="bi bi-calculator-fill text-success"></i> Calculated
              Details
            </legend>

            <div
              class="alert alert-warning border-0 shadow-sm mb-3"
              style="
                background: linear-gradient(
                  135deg,
                  rgba(255, 193, 7, 0.1) 0%,
                  rgba(255, 152, 0, 0.1) 100%
                );
              "
            >
              <div class="d-flex align-items-center">
                <i
                  class="bi bi-exclamation-triangle fs-3 me-3"
                  style="color: #ff9800"
                ></i>
                <div class="w-100">
                  <div class="fw-semibold mb-2">
                    Total Amount with Interest:
                  </div>
                  <span
                    id="total_with_interest"
                    class="fs-3 fw-bold"
                    style="color: #ff9800"
                  >
                    {{ "%.2f"|format(loan_data.amount_aud) }} AUD
                  </span>
                </div>
              </div>
            </div>

            <div
              class="alert alert-success border-0 shadow-sm"
              style="
                background: linear-gradient(
                  135deg,
                  rgba(11, 163, 96, 0.1) 0%,
                  rgba(60, 186, 146, 0.1) 100%
                );
              "
            >
              <div class="d-flex align-items-center">
                <i class="bi bi-cash-coin fs-3 me-3" style="color: #0ba360"></i>
                <div class="w-100">
                  <div class="fw-semibold mb-2">Required Monthly Payment:</div>
                  <span
                    id="monthly_payment"
                    class="fs-3 fw-bold"
                    style="color: #0ba360"
                  >
                    {{ "%.2f"|format(settings.default_loan_repayment) }} AUD
                  </span>
                  <div class="small text-muted mt-1">
                    <i class="bi bi-info-circle"></i> This will automatically
                    update based on your loan amount, period, and interest rate
                  </div>
                </div>
              </div>
            </div>
          </fieldset>

          <input
            type="hidden"
            id="calculated_monthly_payment"
            name="loan_repayment"
            value="{{ settings.default_loan_repayment }}"
          />

          <div class="d-grid gap-3 mt-5">
            <button type="submit" class="btn btn-primary btn-lg py-3 shadow">
              <i class="bi bi-save fs-5"></i> Save Changes
            </button>
            <a
              href="{{ url_for('loan_page') }}"
              class="btn btn-secondary btn-lg py-3"
            >
              <i class="bi bi-x-circle"></i> Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Live conversion calculator with animation
  const loanInput = document.getElementById('loan_amount_bdt');
  const convertedSpan = document.getElementById('converted_amount');
  const interestRateInput = document.getElementById('loan_interest_rate');
  const loanPeriodInput = document.getElementById('loan_period_months');
  const totalWithInterestSpan = document.getElementById('total_with_interest');
  const monthlyPaymentSpan = document.getElementById('monthly_payment');
  const hiddenMonthlyPayment = document.getElementById('calculated_monthly_payment');
  const exchangeRate = {{ settings.bdt_to_aud_rate }};

  function calculateLoan() {
    const bdtAmount = parseFloat(loanInput.value) || 0;
    const audAmount = bdtAmount * exchangeRate;
    const interestRate = parseFloat(interestRateInput.value) || 0;
    const periodMonths = parseInt(loanPeriodInput.value) || 1;

    // Update converted amount
    convertedSpan.style.transform = 'scale(1.1)';
    convertedSpan.textContent = audAmount.toFixed(2) + ' AUD';
    setTimeout(() => {
      convertedSpan.style.transform = 'scale(1)';
    }, 200);

    // Calculate total with interest (simple interest)
    const monthlyInterestRate = (interestRate / 100) / 12;
    let totalWithInterest, monthlyPayment;

    if (interestRate > 0) {
      // Using compound interest formula for monthly payments
      // M = P * [r(1+r)^n] / [(1+r)^n - 1]
      const r = monthlyInterestRate;
      const n = periodMonths;
      const factor = Math.pow(1 + r, n);
      monthlyPayment = audAmount * (r * factor) / (factor - 1);
      totalWithInterest = monthlyPayment * periodMonths;
    } else {
      // No interest
      totalWithInterest = audAmount;
      monthlyPayment = audAmount / periodMonths;
    }

    // Update UI with animation
    totalWithInterestSpan.style.transform = 'scale(1.1)';
    totalWithInterestSpan.textContent = totalWithInterest.toFixed(2) + ' AUD';
    setTimeout(() => {
      totalWithInterestSpan.style.transform = 'scale(1)';
    }, 200);

    monthlyPaymentSpan.style.transform = 'scale(1.1)';
    monthlyPaymentSpan.textContent = monthlyPayment.toFixed(2) + ' AUD';
    hiddenMonthlyPayment.value = monthlyPayment.toFixed(2);
    setTimeout(() => {
      monthlyPaymentSpan.style.transform = 'scale(1)';
    }, 200);
  }

  // Add event listeners
  loanInput.addEventListener('input', calculateLoan);
  interestRateInput.addEventListener('input', calculateLoan);
  loanPeriodInput.addEventListener('input', calculateLoan);

  // Add smooth transitions
  convertedSpan.style.transition = 'transform 0.2s ease';
  totalWithInterestSpan.style.transition = 'transform 0.2s ease';
  monthlyPaymentSpan.style.transition = 'transform 0.2s ease';

  // Calculate on page load
  calculateLoan();
</script>

<style>
  .form-control:focus,
  .input-group-text {
    border-color: #667eea;
  }

  .input-group-text {
    transition: all 0.3s ease;
  }

  .form-control:focus + .input-group-text,
  .form-control:focus ~ .input-group-text {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    border-color: #667eea;
  }
</style>

{% endblock %}
