{% extends "base.html" %} {% block title %}Capital Sources{% endblock %} {%
block content %}
<header class="mb-4">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="display-5 mb-2">
        <i class="bi bi-wallet2 text-primary"></i> Capital Sources
      </h1>
      <p class="lead text-muted mb-0">
        Your initial funding in BDT and converted to {{
        settings.get('target_currency', 'AUD') }}
      </p>
    </div>
    <a
      href="{{ url_for('edit_sources_page') }}"
      class="btn btn-primary btn-lg shadow"
    >
      <i class="bi bi-pencil-square"></i> Edit Sources & Rate
    </a>
  </div>

  <!-- Country Selector -->
  <div
    class="card shadow-sm border-0 mb-4"
    style="
      background: linear-gradient(
        135deg,
        rgba(102, 126, 234, 0.05) 0%,
        rgba(118, 75, 162, 0.05) 100%
      );
    "
  >
    <div class="card-body p-3">
      <div class="row align-items-center">
        <div class="col-md-3">
          <h6 class="mb-2 fw-bold">
            <i class="bi bi-globe-americas"></i> Select Your Country
          </h6>
          <p class="small text-muted mb-0">
            Currency will be automatically set
          </p>
        </div>
        <div class="col-md-9">
          <div class="row g-3">
            <div class="col-md-8">
              <select class="form-select form-select-lg" id="countrySelector">
                <optgroup label="Popular Destinations">
                  <option value="AUD" {% if settings.get('target_currency', 'AUD') == 'AUD' %}selected{% endif %}>ðŸ‡¦ðŸ‡º Australia (AUD)</option>
                  <option value="USD" {% if settings.get('target_currency') == 'USD' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ United States (USD)</option>
                  <option value="NZD" {% if settings.get('target_currency') == 'NZD' %}selected{% endif %}>ðŸ‡³ðŸ‡¿ New Zealand (NZD)</option>
                  <option value="GBP" {% if settings.get('target_currency') == 'GBP' %}selected{% endif %}>ðŸ‡¬ðŸ‡§ United Kingdom (GBP)</option>
                  <option value="CAD" {% if settings.get('target_currency') == 'CAD' %}selected{% endif %}>ðŸ‡¨ðŸ‡¦ Canada (CAD)</option>
                  <option value="EUR" {% if settings.get('target_currency') == 'EUR' %}selected{% endif %}>ðŸ‡ªðŸ‡º European Union (EUR)</option>
                </optgroup>
                <optgroup label="Asia Pacific">
                  <option value="SGD" {% if settings.get('target_currency') == 'SGD' %}selected{% endif %}>ðŸ‡¸ðŸ‡¬ Singapore (SGD)</option>
                  <option value="MYR" {% if settings.get('target_currency') == 'MYR' %}selected{% endif %}>ðŸ‡²ðŸ‡¾ Malaysia (MYR)</option>
                  <option value="JPY" {% if settings.get('target_currency') == 'JPY' %}selected{% endif %}>ðŸ‡¯ðŸ‡µ Japan (JPY)</option>
                  <option value="KRW" {% if settings.get('target_currency') == 'KRW' %}selected{% endif %}>ðŸ‡°ðŸ‡· South Korea (KRW)</option>
                  <option value="CNY" {% if settings.get('target_currency') == 'CNY' %}selected{% endif %}>ðŸ‡¨ðŸ‡³ China (CNY)</option>
                  <option value="INR" {% if settings.get('target_currency') == 'INR' %}selected{% endif %}>ðŸ‡®ðŸ‡³ India (INR)</option>
                  <option value="THB" {% if settings.get('target_currency') == 'THB' %}selected{% endif %}>ðŸ‡¹ðŸ‡­ Thailand (THB)</option>
                </optgroup>
                <optgroup label="Europe">
                  <option value="CHF" {% if settings.get('target_currency') == 'CHF' %}selected{% endif %}>ðŸ‡¨ðŸ‡­ Switzerland (CHF)</option>
                  <option value="SEK" {% if settings.get('target_currency') == 'SEK' %}selected{% endif %}>ðŸ‡¸ðŸ‡ª Sweden (SEK)</option>
                  <option value="NOK" {% if settings.get('target_currency') == 'NOK' %}selected{% endif %}>ðŸ‡³ðŸ‡´ Norway (NOK)</option>
                  <option value="DKK" {% if settings.get('target_currency') == 'DKK' %}selected{% endif %}>ðŸ‡©ðŸ‡° Denmark (DKK)</option>
                </optgroup>
                <optgroup label="Middle East">
                  <option value="AED" {% if settings.get('target_currency') == 'AED' %}selected{% endif %}>ðŸ‡¦ðŸ‡ª UAE (AED)</option>
                  <option value="SAR" {% if settings.get('target_currency') == 'SAR' %}selected{% endif %}>ðŸ‡¸ðŸ‡¦ Saudi Arabia (SAR)</option>
                </optgroup>
              </select>
            </div>
            <div class="col-md-4">
              <div class="alert alert-info mb-0 p-3 h-100 d-flex align-items-center">
                <div>
                  <strong class="d-block">Current:</strong>
                  <span class="fs-5 fw-bold">{{ settings.get('target_currency', 'AUD') }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="row g-4 mb-4">
  {% set colors = [ 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
  'linear-gradient(135deg, #0ba360 0%, #3cba92 100%)', 'linear-gradient(135deg,
  #f093fb 0%, #f5576c 100%)' ] %} {% for source in capital.sources %}
  <div class="col-md-4">
    <div class="card h-100 border-0 shadow-lg" style="overflow: hidden">
      <div
        class="card-header text-white text-center py-3"
        style="background: {{ colors[loop.index0 % 3] }};"
      >
        <i
          class="bi bi-{% if source.name == 'Parents' %}heart-fill{% elif source.name == 'Jethu' %}people-fill{% else %}bank{% endif %} fs-1"
        ></i>
        <h2 class="mt-2 mb-0 fw-bold">{{ source.name }}</h2>
      </div>
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <p
            class="display-5 fw-bold mb-1"
            style="background: {{ colors[loop.index0 % 3] }}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;"
          >
            {{ "%.2f"|format(source.amount_aud) }}
          </p>
          <span class="fs-6 text-muted fw-semibold"
            >{{ settings.get('target_currency', 'AUD') }}</span
          >
        </div>
        <div class="p-2 rounded" style="background: rgba(102, 126, 234, 0.05)">
          <p class="h6 text-muted mb-0">
            <i class="bi bi-currency-exchange"></i> {{
            "{:,.0f}".format(source.amount_bdt) }} BDT
          </p>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div
      class="card shadow-lg border-0 h-100"
      style="
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.05) 0%,
          rgba(118, 75, 162, 0.05) 100%
        );
      "
    >
      <div class="card-body text-center p-3">
        <div class="mb-2">
          <i
            class="bi bi-piggy-bank-fill fs-1"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
            "
          ></i>
        </div>
        <h3 class="fw-bold mb-2">Total Initial Capital</h3>
        <p
          class="display-4 fw-bold mb-2"
          style="
            background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
          "
        >
          {{ "%.2f"|format(capital.total_capital_aud) }} {{
          settings.get('target_currency', 'AUD') }}
        </p>
        <p class="h5 text-muted mb-3">
          {{ "{:,.0f}".format(capital.sources|sum(attribute='amount_bdt')) }}
          BDT
        </p>
        <div
          class="alert alert-light border-0 d-inline-block px-3 py-2 shadow-sm"
        >
          <i class="bi bi-info-circle-fill text-primary"></i>
          <small class="fw-semibold"
            >Calculated at rate: 1 BDT = {{ settings.current_rate }} {{
            settings.get('target_currency', 'AUD') }}</small
          >
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div
      class="card shadow-lg border-0 h-100"
      style="
        background: linear-gradient(
          135deg,
          rgba(11, 163, 96, 0.05) 0%,
          rgba(60, 186, 146, 0.05) 100%
        );
      "
    >
      <div class="card-body p-3">
        <div class="text-center mb-3">
          <i
            class="bi bi-arrow-left-right fs-1"
            style="
              background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
            "
          ></i>
        </div>
        <h3 class="fw-bold text-center mb-3">Exchange Rate</h3>

        <div class="text-center mb-3">
          <p class="h6 text-muted mb-2">1 BDT =</p>
          <p
            id="current-rate-display"
            class="display-4 fw-bold"
            style="
              background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
            "
          >
            {{ settings.current_rate }} {{ settings.get('target_currency',
            'AUD') }}
          </p>
        </div>

        <div
          id="rate-status"
          class="alert alert-light border-0 shadow-sm mb-3"
          style="background: white"
        >
          <div class="d-flex align-items-center justify-content-center">
            <i class="bi bi-clock-history me-2"></i>
            <small class="fw-semibold">
              {% if settings.get('exchange_rate_last_updated') %} Last updated:
              {{ settings.exchange_rate_last_updated[:19] }}
              <span class="badge bg-success ms-2"
                >{{ settings.get('exchange_rate_source', 'ExchangeRate-API')
                }}</span
              >
              {% else %} Click below to fetch the latest rates {% endif %}
            </small>
          </div>
        </div>

        <div id="rate-message" class="mb-2"></div>

        <div class="d-grid">
          <button
            type="button"
            class="btn btn-success btn-lg py-2 shadow"
            id="fetchRateBtn"
            onclick="fetchExchangeRate()"
          >
            <i class="bi bi-arrow-clockwise"></i> Fetch Current Rate
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Country selector handler
  const countrySelector = document.getElementById('countrySelector');
  
  countrySelector.addEventListener('change', async function() {
    const currency = this.value;
    
    // Show loading state
    this.disabled = true;
    this.style.opacity = '0.6';
    
    try {
      const response = await fetch(`/set_currency/${currency}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success mt-2';
        alertDiv.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>Currency changed to ${currency}! Refreshing...`;
        countrySelector.parentElement.appendChild(alertDiv);
        
        // Reload page after short delay
        setTimeout(() => {
          location.reload();
        }, 1000);
      }
    } catch (error) {
      console.error('Error changing currency:', error);
      alert('Failed to change currency. Please try again.');
      this.disabled = false;
      this.style.opacity = '1';
    }
  });

  async function fetchExchangeRate() {
    const fetchBtn = document.getElementById("fetchRateBtn");
    const rateDisplay = document.getElementById("current-rate-display");
    const rateStatus = document.getElementById("rate-status");
    const messageDiv = document.getElementById("rate-message");

    // Disable button and show loading
    fetchBtn.disabled = true;
    fetchBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2"></span> Fetching...';
    messageDiv.innerHTML = "";

    try {
      const response = await fetch("/api/fetch_exchange_rate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      const data = await response.json();

      if (data.success) {
        // Update the rate display with animation
        rateDisplay.style.transform = "scale(1.1)";
        rateDisplay.textContent =
          data.current_rate + " " + data.current_currency;
        setTimeout(() => {
          rateDisplay.style.transform = "scale(1)";
        }, 300);

        // Show success message with all rates
        const ratesInfo = `AUD: ${data.rates.AUD}, USD: ${data.rates.USD}, NZD: ${data.rates.NZD}`;
        messageDiv.innerHTML = `
          <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <div class="d-flex align-items-center">
              <i class="bi bi-check-circle-fill fs-4 me-3"></i>
              <div>
                <strong>Success!</strong> All exchange rates updated (${ratesInfo}). Refreshing page...
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;

        // Update status
        rateStatus.innerHTML = `
          <div class="d-flex align-items-center justify-content-center">
            <i class="bi bi-clock-history me-2"></i>
            <small class="fw-semibold">
              Last updated: ${data.formatted_time}
              <span class="badge bg-success ms-2">ExchangeRate-API</span>
            </small>
          </div>
        `;

        // Reload page after 1.5 seconds to show updated amounts
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        // Show error message
        messageDiv.innerHTML = `
          <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <div class="d-flex align-items-center">
              <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
              <div>
                <strong>Error!</strong> ${data.error}
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;

        // Re-enable button on error
        fetchBtn.disabled = false;
        fetchBtn.innerHTML =
          '<i class="bi bi-arrow-clockwise"></i> Fetch Current Rate';
      }
    } catch (error) {
      // Show network error
      messageDiv.innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
          <div class="d-flex align-items-center">
            <i class="bi bi-wifi-off fs-4 me-3"></i>
            <div>
              <strong>Network Error!</strong> ${error.message}
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;

      // Re-enable button on error
      fetchBtn.disabled = false;
      fetchBtn.innerHTML =
        '<i class="bi bi-arrow-clockwise"></i> Fetch Current Rate';
    }
  }

  // Add smooth transition to rate display
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("current-rate-display").style.transition =
      "transform 0.3s ease";
  });
</script>

<style>
  .card {
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .card:hover {
    transform: translateY(-10px) scale(1.02);
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .alert {
    animation: slideInUp 0.4s ease;
  }

  .spinner-border {
    width: 1rem;
    height: 1rem;
  }
</style>

{% endblock %}
